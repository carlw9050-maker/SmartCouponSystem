<?xml version="1.0" encoding="UTF-8" ?>


<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nageoffer.onecoupon.distribution.dao.mapper.UserCouponMapper">

    <!-- 查询用户优惠券最大领取次数 -->
    <select id="selectUserCourseMaxReceiveCount"
            resultType="com.nageoffer.onecoupon.distribution.dao.entity.UserCouponDO">
        SELECT a.user_id,
        a.receive_count
        FROM t_user_coupon AS a
        WHERE a.user_id IN
        <foreach item="userId" collection="userIds" open="(" separator="," close=")">
            #{userId}
        </foreach>
        AND a.coupon_template_id = #{couponTemplateId}
        AND (
        SELECT COUNT(*)
        FROM t_user_coupon AS b
        WHERE b.user_id = a.user_id
        AND b.coupon_template_id = a.coupon_template_id
        AND b.receive_count > a.receive_count
        ) = 0;
    </select>
</mapper>